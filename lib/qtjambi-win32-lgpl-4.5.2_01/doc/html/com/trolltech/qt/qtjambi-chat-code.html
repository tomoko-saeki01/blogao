<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>Code for Chat Example</title><link href="classic.css" rel="stylesheet" type="text/css" />
</head><table border="0" cellpadding="0" cellspacing="0" width="100%">
 <tr>
 <td align="left" valign="top" width="32"> <img src="images/qt-logo.png" align="left" width="32" height="32" border="0" /> </td>
 <td width="1">&nbsp;&nbsp;</td> <td class="postheader" valign="center"> <a href="qtjambi-index.html"> <font color="#004faf">Home</font></a>&nbsp;&middot; <a href="qtjambi-examples.html"> <font color="#004faf">Examples</font></a>&nbsp; </td>
 </tr></table><body><p><hr><p><center><h1>Code for Chat Example</h1></center><p><pre class="snippet"><html style="white-space:pre-wrap;font-family:courier new"><font color=darkgreen><i>/****************************************************************************
 **
 ** Copyright (C) 1992-2009 Nokia Corporation and/or its subsidiary(-ies).
** All rights reserved.
 **
 ** This file is part of Qt Jambi.
 **
 ** 
** Commercial Usage
** Licensees holding valid Qt Commercial licenses may use this file in
** accordance with the Qt Commercial License Agreement provided with the
** Software or, alternatively, in accordance with the terms contained in
** a written agreement between you and Nokia.
** 
** GNU Lesser General Public License Usage
** Alternatively, this file may be used under the terms of the GNU Lesser
** General Public License version 2.1 as published by the Free Software
** Foundation and appearing in the file LICENSE.LGPL included in the
** packaging of this file.  Please review the following information to
** ensure the GNU Lesser General Public License version 2.1 requirements
** will be met: http:<font color=darkgreen><i>//www.gnu.org/licenses/old-licenses/lgpl-2.1.html.
</i></font>** 
** In addition, as a special exception, Nokia gives you certain
** additional rights. These rights are described in the Nokia Qt LGPL
** Exception version 1.0, included in the file LGPL_EXCEPTION.txt in this
** package.
** 
** GNU General Public License Usage
** Alternatively, this file may be used under the terms of the GNU
** General Public License version 3.0 as published by the Free Software
** Foundation and appearing in the file LICENSE.GPL included in the
** packaging of this file.  Please review the following information to
** ensure the GNU General Public License version 3.0 requirements will be
** met: http:<font color=darkgreen><i>//www.gnu.org/copyleft/gpl.html.
</i></font>** 
** If you are unsure which license is appropriate for your use, please
** contact the sales department at qt-sales@nokia.com.
 **
 ** This file is provided AS IS with NO WARRANTY OF ANY KIND, INCLUDING THE
 ** WARRANTY OF DESIGN, MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.
 **
 ****************************************************************************/</i></font>

<font color=blue>package</font> com.trolltech.examples;

<font color=blue>import</font> com.trolltech.qt.core.*;
<font color=blue>import</font> com.trolltech.qt.core.<font color=darkmagenta><i>Qt</i></font>.*;
<font color=blue>import</font> com.trolltech.qt.gui.*;
<font color=blue>import</font> com.trolltech.qt.network.*;

<font color=blue>import</font> java.util.*;

@<font color=darkmagenta><i>QtJambiExample</i></font>(name = <font color=darkgreen><i>"Chat"</i></font>)
<font color=blue>public</font> <font color=blue>class</font> Chat <font color=blue>extends</font> <font color=darkmagenta><i>QDialog</i></font> {

    <font color=blue>public</font> <font color=blue>static</font> <font color=blue>void</font> main(String[] args) {

        <font color=darkmagenta><i>QApplication</i></font>.initialize(args);
        Chat chat = <font color=blue>new</font> Chat();
        chat.show();
        <font color=darkmagenta><i>QApplication</i></font>.exec();

    }

    <font color=blue>private</font> Ui_ChatDialog ui = <font color=blue>new</font> Ui_ChatDialog();
    <font color=blue>private</font> Client client = <font color=blue>new</font> Client();
    <font color=blue>private</font> String myNickName;
    <font color=blue>private</font> <font color=darkmagenta><i>QTextTableFormat</i></font> tableFormat = <font color=blue>new</font> <font color=darkmagenta><i>QTextTableFormat</i></font>();

    <font color=blue>public</font> Chat() {
        <font color=blue>this</font>(null);
    }

    <font color=blue>public</font> Chat(<font color=darkmagenta><i>QWidget</i></font> parent) {
        <font color=blue>super</font>(parent);

        ui.setupUi(<font color=blue>this</font>);

        ui.lineEdit.setFocusPolicy(<font color=darkmagenta><i>Qt</i></font>.FocusPolicy.StrongFocus);
        ui.textEdit.setFocusPolicy(<font color=darkmagenta><i>Qt</i></font>.FocusPolicy.NoFocus);
        ui.textEdit.setReadOnly(true);
        ui.listWidget.setFocusPolicy(<font color=darkmagenta><i>Qt</i></font>.FocusPolicy.NoFocus);

        ui.lineEdit.returnPressed.connect(<font color=blue>this</font>, <font color=darkgreen><i>"returnPressed()"</i></font>);

        client.newMessage__from__message.connect(<font color=blue>this</font>, <font color=darkgreen><i>"appendMessage(String, String)"</i></font>);
        client.newParticipant__nick.connect(<font color=blue>this</font>, <font color=darkgreen><i>"newParticipant(String)"</i></font>);
        client.participantLeft__nick.connect(<font color=blue>this</font>, <font color=darkgreen><i>"participantLeft(String)"</i></font>);

        myNickName = client.nickName();
        newParticipant(myNickName);
        tableFormat.setBorder(0);

        setWindowTitle(<font color=darkgreen><i>"Chat "</i></font> + myNickName);

        <font color=darkmagenta><i>QTimer</i></font>.singleShot(10 * 1000, <font color=blue>this</font>, <font color=darkgreen><i>"showInformation()"</i></font>);
    }

    <font color=blue>public</font> String tr(String str, Object... arguments) {
        <font color=blue>return</font> String.format(tr(str), arguments);
    }

    <font color=blue>private</font> <font color=blue>void</font> appendMessage(<font color=blue>final</font> String from, <font color=blue>final</font> String message) {
        <font color=blue>if</font> (from.equals(<font color=darkgreen><i>""</i></font>) || message.equals(<font color=darkgreen><i>""</i></font>))
            <font color=blue>return</font>;

        <font color=darkmagenta><i>QTextCursor</i></font> cursor = <font color=blue>new</font> <font color=darkmagenta><i>QTextCursor</i></font>(ui.textEdit.textCursor());
        cursor.movePosition(<font color=darkmagenta><i>QTextCursor</i></font>.MoveOperation.End);
        <font color=darkmagenta><i>QTextTable</i></font> table = cursor.insertTable(1, 2, tableFormat);
        table.cellAt(0, 0).firstCursorPosition().insertText(<font color=darkgreen><i>"&lt;"</i></font> + from + <font color=darkgreen><i>"&gt; "</i></font>);
        table.cellAt(0, 1).firstCursorPosition().insertText(message);
        <font color=darkmagenta><i>QScrollBar</i></font> bar = ui.textEdit.verticalScrollBar();
        bar.setValue(bar.maximum());
    }

    <font color=blue>void</font> returnPressed() {
        String text = ui.lineEdit.text();
        <font color=blue>if</font> (text.equals(<font color=darkgreen><i>""</i></font>))
            <font color=blue>return</font>;

        <font color=blue>if</font> (text.startsWith(<font color=darkgreen><i>"/"</i></font>)) {
            <font color=darkmagenta><i>QColor</i></font> color = ui.textEdit.textColor();
            ui.textEdit.setTextColor(<font color=darkmagenta><i>QColor</i></font>.red);
            ui.textEdit.append(tr(<font color=darkgreen><i>"! Unknown command: "</i></font>) + text.substring(text.indexOf(' ')));
            ui.textEdit.setTextColor(color);
        } <font color=blue>else</font> {
            client.sendMessage(text);
            appendMessage(myNickName, text);
        }

        ui.lineEdit.clear();
    }

    <font color=blue>private</font> <font color=blue>void</font> newParticipant(<font color=blue>final</font> String nick) {
        <font color=blue>if</font> (nick.equals(<font color=darkgreen><i>""</i></font>))
            <font color=blue>return</font>;

        <font color=darkmagenta><i>QColor</i></font> color = ui.textEdit.textColor();
        ui.textEdit.setTextColor(<font color=darkmagenta><i>QColor</i></font>.gray);
        ui.textEdit.append(String.format(tr(<font color=darkgreen><i>"* %1$s has joined"</i></font>), nick));
        ui.textEdit.setTextColor(color);
        ui.listWidget.addItem(<font color=blue>new</font> <font color=darkmagenta><i>QListWidgetItem</i></font>(nick));
    }

    <font color=blue>void</font> participantLeft(<font color=blue>final</font> String nick) {
        <font color=blue>if</font> (nick.equals(<font color=darkgreen><i>""</i></font>))
            <font color=blue>return</font>;

        List&lt;<font color=darkmagenta><i>QListWidgetItem</i></font>&gt; items = ui.listWidget.findItems(nick, MatchFlag.MatchExactly);

        <font color=blue>for</font> (Iterator&lt;<font color=darkmagenta><i>QListWidgetItem</i></font>&gt; iterator = items.iterator(); iterator.hasNext();) {
            <font color=darkmagenta><i>QListWidgetItem</i></font> item = (<font color=darkmagenta><i>QListWidgetItem</i></font>) iterator.next();
            ui.listWidget.removeItemWidget(item);
            ui.listWidget.takeItem(ui.listWidget.row(item));
        }

        <font color=darkmagenta><i>QColor</i></font> color = ui.textEdit.textColor();
        ui.textEdit.setTextColor(<font color=darkmagenta><i>QColor</i></font>.gray);
        ui.textEdit.append(String.format(tr(<font color=darkgreen><i>"* %1$s has left"</i></font>), nick));
        ui.textEdit.setTextColor(color);
    }

    <font color=blue>void</font> showInformation() {
        <font color=blue>if</font> (ui.listWidget.count() == 1) {
            <font color=darkmagenta><i>QMessageBox</i></font>.information(<font color=blue>this</font>, tr(<font color=darkgreen><i>"Chat"</i></font>), tr(<font color=darkgreen><i>"Launch several instances of this "</i></font> + <font color=darkgreen><i>"program on your local network and "</i></font> + <font color=darkgreen><i>"start chatting!"</i></font>));
        }
    }

    <font color=blue>class</font> Client <font color=blue>extends</font> <font color=darkmagenta><i>QObject</i></font> {

        <font color=blue>private</font> PeerManager peerManager;
        <font color=blue>private</font> Server server = <font color=blue>new</font> Server(<font color=blue>this</font>);
        <font color=blue>private</font> Vector&lt;Connection&gt; peers = <font color=blue>new</font> Vector&lt;Connection&gt;();
        <font color=blue>private</font> Vector&lt;Connection&gt; inConnection = <font color=blue>new</font> Vector&lt;Connection&gt;();

        <font color=darkgreen><i>// from, message
</i></font>        Signal2&lt;String, String&gt; newMessage__from__message = <font color=blue>new</font> Signal2&lt;String, String&gt;();
        <font color=darkgreen><i>// nick
</i></font>        Signal1&lt;String&gt; newParticipant__nick = <font color=blue>new</font> Signal1&lt;String&gt;();
        <font color=darkgreen><i>// nick
</i></font>        Signal1&lt;String&gt; participantLeft__nick = <font color=blue>new</font> Signal1&lt;String&gt;();

        Client() {
            peerManager = <font color=blue>new</font> PeerManager(server);
            peerManager.startBroadcasting();

            peerManager.newConnection__hostAddress_port.connect(<font color=blue>this</font>, <font color=darkgreen><i>"newConnection(QHostAddress, int)"</i></font>);
            server.newConnection__descriptor.connect(<font color=blue>this</font>, <font color=darkgreen><i>"newConnection(int)"</i></font>);
        }

        <font color=blue>public</font> <font color=blue>synchronized</font> <font color=blue>void</font> sendMessage(<font color=blue>final</font> String message) {
            <font color=blue>if</font> (message.equals(<font color=darkgreen><i>""</i></font>))
                <font color=blue>return</font>;

            <font color=blue>for</font> (Connection connection : peers) {
                connection.sendMessage(message);
            }
        }

        <font color=blue>public</font> String nickName() {
            <font color=blue>return</font> peerManager.userName() + <font color=darkgreen><i>"@"</i></font> + <font color=darkmagenta><i>QHostInfo</i></font>.localHostName() + <font color=darkgreen><i>":"</i></font> + (<font color=blue>int</font>) server.serverPort();
        }

        <font color=blue>protected</font> <font color=blue>void</font> newConnection(<font color=darkmagenta><i>QHostAddress</i></font> address, <font color=blue>int</font> port) {
            <font color=blue>if</font> (inConnection.isEmpty()) {
                <font color=blue>for</font> (Connection conn : peers) {
                    <font color=blue>if</font> (conn.equals(address, port))
                        <font color=blue>return</font>;
                }
                Connection connection = <font color=blue>new</font> Connection(<font color=blue>this</font>, port, server.serverPort());
                connection.connectToHost(address, port, <font color=blue>new</font> <font color=darkmagenta><i>QIODevice</i></font>.OpenMode(<font color=darkmagenta><i>QIODevice</i></font>.OpenModeFlag.ReadWrite));
                newConnection(connection);
            }
        }

        <font color=blue>protected</font> <font color=blue>void</font> newConnection(<font color=blue>int</font> descriptor) {
            Connection connection = <font color=blue>new</font> Connection(<font color=blue>this</font>, -1, server.serverPort());
            connection.setSocketDescriptor(descriptor);
            newConnection(connection);
        }

        <font color=blue>private</font> <font color=blue>void</font> newConnection(Connection connection) {
            inConnection.add(connection);
            connection.setGreetingMessage(peerManager.userName().toString());

            connection.error.connect(<font color=blue>this</font>, <font color=darkgreen><i>"connectionError(QAbstractSocket$SocketError)"</i></font>);
            connection.disconnected.connect(<font color=blue>this</font>, <font color=darkgreen><i>"disconnected()"</i></font>);
            connection.readyForUse.connect(<font color=blue>this</font>, <font color=darkgreen><i>"readyForUse()"</i></font>);
        }

        <font color=blue>protected</font> <font color=blue>synchronized</font> <font color=blue>void</font> readyForUse() {
            Connection connection = (Connection) signalSender();

            connection.newMessage.connect(<font color=blue>this</font>.newMessage__from__message);

            peers.add(connection);

            String nick = connection.name();

            <font color=blue>if</font> (!nick.equals(<font color=darkgreen><i>""</i></font>))
                newParticipant__nick.emit(nick);

            inConnection.removeElement(connection);
        }

        <font color=blue>protected</font> <font color=blue>void</font> disconnected() {
            removeConnection((Connection) signalSender());
        }

        <font color=blue>protected</font> <font color=blue>void</font> connectionError(<font color=darkmagenta><i>QAbstractSocket</i></font>.SocketError socketError) {
            removeConnection((Connection) signalSender());
        }

        <font color=blue>protected</font> <font color=blue>void</font> removeConnection(Connection con) {
            <font color=blue>if</font> (peers.removeElement(con)) {
                String nick = con.name();
                <font color=blue>if</font> (!nick.equals(<font color=darkgreen><i>""</i></font>))
                    participantLeft__nick.emit(nick);
            }
        }
    }

    <font color=blue>static</font> <font color=blue>class</font> Connection <font color=blue>extends</font> <font color=darkmagenta><i>QTcpSocket</i></font> {

        <font color=blue>static</font> <font color=blue>final</font> <font color=blue>int</font> MaxBufferSize = 1024000;
        <font color=blue>static</font> <font color=blue>final</font> <font color=blue>int</font> TransferTimeout = 30 * 1000;
        <font color=blue>static</font> <font color=blue>final</font> <font color=blue>int</font> PongTimeout = 60 * 1000;
        <font color=blue>static</font> <font color=blue>final</font> <font color=blue>int</font> PingInterval = 5 * 1000;
        <font color=blue>static</font> <font color=blue>final</font> <font color=blue>char</font> SeparatorToken = ' ';

        <font color=blue>private</font> <font color=blue>enum</font> ConnectionState {
            WaitingForGreeting, ReadingGreeting, ReadyForUse
        };

        <font color=blue>private</font> <font color=blue>enum</font> DataType {
            PlainText, Ping, Pong, Greeting, Undefined
        };

        Signal0 readyForUse = <font color=blue>new</font> Signal0();
        Signal2&lt;String, String&gt; newMessage = <font color=blue>new</font> Signal2&lt;String, String&gt;();

        <font color=blue>private</font> <font color=darkmagenta><i>QTextCodec</i></font> codec = <font color=darkmagenta><i>QTextCodec</i></font>.codecForName(<font color=blue>new</font> <font color=darkmagenta><i>QByteArray</i></font>(<font color=darkgreen><i>"UTF-8"</i></font>));

        <font color=blue>private</font> String greetingMessage;
        <font color=blue>private</font> String username;
        <font color=blue>private</font> <font color=darkmagenta><i>QTimer</i></font> pingTimer = <font color=blue>new</font> <font color=darkmagenta><i>QTimer</i></font>();
        <font color=blue>private</font> <font color=darkmagenta><i>QTime</i></font> pongTime = <font color=blue>new</font> <font color=darkmagenta><i>QTime</i></font>();
        <font color=blue>private</font> <font color=darkmagenta><i>QByteArray</i></font> buffer = <font color=blue>new</font> <font color=darkmagenta><i>QByteArray</i></font>();
        <font color=blue>private</font> ConnectionState state;
        <font color=blue>private</font> DataType currentDataType;
        <font color=blue>private</font> <font color=blue>int</font> numBytesForCurrentDataType;
        <font color=blue>private</font> <font color=blue>int</font> transferTimerId;
        <font color=blue>private</font> <font color=blue>boolean</font> isGreetingMessageSent;
        <font color=blue>private</font> <font color=blue>int</font> otherServerPort;
        <font color=blue>private</font> <font color=blue>int</font> thisServerPort;

        Connection(<font color=darkmagenta><i>QObject</i></font> parent, <font color=blue>int</font> otherServerPort, <font color=blue>int</font> thisServerPort) {
            <font color=blue>super</font>(parent);
            <font color=blue>this</font>.otherServerPort = otherServerPort;
            <font color=blue>this</font>.thisServerPort = thisServerPort;
            greetingMessage = tr(<font color=darkgreen><i>"undefined"</i></font>);
            username = tr(<font color=darkgreen><i>"unknown"</i></font>);
            state = ConnectionState.WaitingForGreeting;
            currentDataType = DataType.Undefined;
            numBytesForCurrentDataType = -1;
            transferTimerId = 0;
            isGreetingMessageSent = false;
            pingTimer.setInterval(PingInterval);

            readyRead.connect(<font color=blue>this</font>, <font color=darkgreen><i>"processReadyRead()"</i></font>);
            disconnected.connect(pingTimer, <font color=darkgreen><i>"stop()"</i></font>);
            pingTimer.timeout.connect(<font color=blue>this</font>, <font color=darkgreen><i>"sendPing()"</i></font>);
            connected.connect(<font color=blue>this</font>, <font color=darkgreen><i>"sendGreetingMessage()"</i></font>);
        }

        @Override
        <font color=blue>public</font> <font color=blue>boolean</font> equals(Object other) {
            <font color=blue>if</font> (other <font color=blue>instanceof</font> Connection) {
                Connection con = (Connection) other;
                <font color=blue>return</font> (con.peerAddress().equals(peerAddress()) && con.otherServerPort == otherServerPort);
            }
            <font color=blue>return</font> false;
        }

        <font color=blue>public</font> <font color=blue>boolean</font> equals(<font color=darkmagenta><i>QHostAddress</i></font> address, <font color=blue>int</font> port) {
            <font color=blue>return</font> <font color=blue>this</font>.peerAddress().equals(address) && <font color=blue>this</font>.otherServerPort == port;
        }

        String name() {
            <font color=blue>return</font> username;
        }

        <font color=blue>void</font> setGreetingMessage(<font color=blue>final</font> String message) {
            greetingMessage = message;
        }

        <font color=blue>boolean</font> sendMessage(<font color=blue>final</font> String message) {
            <font color=blue>if</font> (message.equals(<font color=darkgreen><i>""</i></font>))
                <font color=blue>return</font> false;

            <font color=darkmagenta><i>QByteArray</i></font> msg = codec.fromUnicode(message);
            <font color=darkmagenta><i>QByteArray</i></font> data = <font color=blue>new</font> <font color=darkmagenta><i>QByteArray</i></font>(<font color=darkgreen><i>"MESSAGE "</i></font> + msg.length() + <font color=darkgreen><i>" "</i></font>);
            data.append(msg);
            <font color=blue>return</font> write(data) == data.size();
        }

        <font color=blue>public</font> <font color=blue>void</font> timerEvent(<font color=darkmagenta><i>QTimerEvent</i></font> timerEvent) {
            <font color=blue>if</font> (timerEvent.timerId() == transferTimerId) {
                abort();
                killTimer(transferTimerId);
                transferTimerId = 0;
            }
        }

        <font color=blue>void</font> processReadyRead() {
            <font color=blue>if</font> (state == ConnectionState.WaitingForGreeting) {
                <font color=blue>if</font> (!readProtocolHeader())
                    <font color=blue>return</font>;
                <font color=blue>if</font> (currentDataType != DataType.Greeting) {
                    abort();
                    <font color=blue>return</font>;
                }
                state = ConnectionState.ReadingGreeting;
            }

            <font color=blue>if</font> (state == ConnectionState.ReadingGreeting) {
                <font color=blue>if</font> (!hasEnoughData())
                    <font color=blue>return</font>;

                buffer = read(numBytesForCurrentDataType);
                <font color=blue>if</font> (buffer.size() != numBytesForCurrentDataType) {
                    abort();
                    <font color=blue>return</font>;
                }

                username = buffer.toString();

                String[] list = username.split(<font color=darkgreen><i>"[:@]"</i></font>);
                <font color=blue>if</font>(list.length!=3) {
                    abort();
                    <font color=blue>return</font>;
                }
                otherServerPort = Integer.parseInt(list[2]);

                currentDataType = DataType.Undefined;
                numBytesForCurrentDataType = 0;
                buffer.clear();

                <font color=blue>if</font> (!isValid()) {
                    abort();
                    <font color=blue>return</font>;
                }

                <font color=blue>if</font> (!isGreetingMessageSent)
                    sendGreetingMessage();

                pingTimer.start();
                pongTime.start();
                state = ConnectionState.ReadyForUse;

                readyForUse.emit();
            }

            <font color=blue>do</font> {
                <font color=blue>if</font> (currentDataType == DataType.Undefined) {
                    <font color=blue>if</font> (!readProtocolHeader())
                        <font color=blue>return</font>;
                }
                <font color=blue>if</font> (!hasEnoughData())
                    <font color=blue>return</font>;
                processData();
            } <font color=blue>while</font> (bytesAvailable() &gt; 0);
        }

        <font color=blue>void</font> sendPing() {
            <font color=blue>if</font> (pongTime.elapsed() &gt; PongTimeout) {
                abort();
                <font color=blue>return</font>;
            }

            write(<font color=blue>new</font> <font color=darkmagenta><i>QByteArray</i></font>(<font color=darkgreen><i>"PING 1 p"</i></font>));
        }

        <font color=blue>private</font> <font color=blue>void</font> sendGreetingMessage() {
            <font color=darkmagenta><i>QByteArray</i></font> greeting = <font color=blue>new</font> <font color=darkmagenta><i>QByteArray</i></font>(greetingMessage + <font color=darkgreen><i>"@"</i></font> + <font color=blue>this</font>.localAddress() + <font color=darkgreen><i>":"</i></font> + thisServerPort);
            <font color=darkmagenta><i>QByteArray</i></font> data = <font color=blue>new</font> <font color=darkmagenta><i>QByteArray</i></font>(<font color=darkgreen><i>"GREETING "</i></font> + greeting.length() + <font color=darkgreen><i>" "</i></font> + greeting);

            <font color=blue>if</font> (write(data) == data.size())
                isGreetingMessageSent = true;
        }

        <font color=blue>private</font> <font color=blue>int</font> readDataIntoBuffer(<font color=blue>int</font> maxSize) {
            <font color=blue>if</font> (maxSize &gt; MaxBufferSize)
                <font color=blue>return</font> 0;

            <font color=blue>int</font> numBytesBeforeRead = buffer.size();
            <font color=blue>if</font> (numBytesBeforeRead == MaxBufferSize) {
                abort();
                <font color=blue>return</font> 0;
            }

            <font color=blue>while</font> (bytesAvailable() &gt; 0 && buffer.size() &lt; maxSize) {
                buffer.append(read(1));
                <font color=blue>if</font> (buffer.endsWith(<font color=darkgreen><i>""</i></font> + SeparatorToken))
                    <font color=blue>break</font>;
            }
            <font color=blue>return</font> buffer.size() - numBytesBeforeRead;
        }

        <font color=blue>private</font> <font color=blue>int</font> dataLengthForCurrentDataType() {
            <font color=blue>if</font> (bytesAvailable() &lt;= 0 || readDataIntoBuffer(MaxBufferSize) &lt;= 0 || !buffer.endsWith(<font color=darkgreen><i>""</i></font> + SeparatorToken))
                <font color=blue>return</font> 0;

            buffer.chop(1);
            <font color=blue>int</font> number = buffer.toInt();
            buffer.clear();
            <font color=blue>return</font> number;
        }

        <font color=blue>private</font> <font color=blue>boolean</font> readProtocolHeader() {
            <font color=blue>if</font> (transferTimerId != 0) {
                killTimer(transferTimerId);
                transferTimerId = 0;
            }

            <font color=blue>if</font> (readDataIntoBuffer(MaxBufferSize) &lt;= 0) {
                transferTimerId = startTimer(TransferTimeout);
                <font color=blue>return</font> false;
            }

            <font color=blue>if</font> (buffer.equals(<font color=darkgreen><i>"PING "</i></font>)) {
                currentDataType = DataType.Ping;
            } <font color=blue>else</font> <font color=blue>if</font> (buffer.equals(<font color=darkgreen><i>"PONG "</i></font>)) {
                currentDataType = DataType.Pong;
            } <font color=blue>else</font> <font color=blue>if</font> (buffer.equals(<font color=darkgreen><i>"MESSAGE "</i></font>)) {
                currentDataType = DataType.PlainText;
            } <font color=blue>else</font> <font color=blue>if</font> (buffer.equals(<font color=darkgreen><i>"GREETING "</i></font>)) {
                currentDataType = DataType.Greeting;
            } <font color=blue>else</font> {
                currentDataType = DataType.Undefined;
                abort();
                <font color=blue>return</font> false;
            }

            buffer.clear();
            numBytesForCurrentDataType = dataLengthForCurrentDataType();
            <font color=blue>return</font> true;
        }

        <font color=blue>private</font> <font color=blue>boolean</font> hasEnoughData() {
            <font color=blue>if</font> (transferTimerId != 0) {
                killTimer(transferTimerId);
                transferTimerId = 0;
            }

            <font color=blue>if</font> (numBytesForCurrentDataType &lt;= 0)
                numBytesForCurrentDataType = dataLengthForCurrentDataType();

            <font color=blue>if</font> (bytesAvailable() &lt; numBytesForCurrentDataType || numBytesForCurrentDataType &lt;= 0) {
                transferTimerId = startTimer(TransferTimeout);
                <font color=blue>return</font> false;
            }

            <font color=blue>return</font> true;
        }

        <font color=blue>private</font> <font color=blue>void</font> processData() {
            buffer = read(numBytesForCurrentDataType);
            <font color=blue>if</font> (buffer.size() != numBytesForCurrentDataType) {
                abort();
                <font color=blue>return</font>;
            }

            <font color=blue>switch</font> (currentDataType) {
            <font color=blue>case</font> PlainText:
                newMessage.emit(username, codec.toUnicode(buffer));
                <font color=blue>break</font>;
            <font color=blue>case</font> Ping:
                write(<font color=blue>new</font> <font color=darkmagenta><i>QByteArray</i></font>(<font color=darkgreen><i>"PONG 1 p"</i></font>));
                <font color=blue>break</font>;
            <font color=blue>case</font> Pong:
                pongTime.restart();
                <font color=blue>break</font>;
            <font color=blue>default</font>:
                <font color=blue>break</font>;
            }

            currentDataType = DataType.Undefined;
            numBytesForCurrentDataType = 0;
            buffer.clear();
        }
    }

    <font color=blue>class</font> PeerManager <font color=blue>extends</font> <font color=darkmagenta><i>QObject</i></font> {
        <font color=blue>static</font> <font color=blue>final</font> <font color=blue>int</font> BroadcastInterval = 2000;
        <font color=blue>static</font> <font color=blue>final</font> <font color=blue>int</font> broadcastPort = 45000;

        <font color=blue>private</font> Server server;
        <font color=blue>private</font> Vector&lt;<font color=darkmagenta><i>QHostAddress</i></font>&gt; broadcastAddresses = <font color=blue>new</font> Vector&lt;<font color=darkmagenta><i>QHostAddress</i></font>&gt;();
        <font color=blue>private</font> Vector&lt;<font color=darkmagenta><i>QHostAddress</i></font>&gt; ipAddresses = <font color=blue>new</font> Vector&lt;<font color=darkmagenta><i>QHostAddress</i></font>&gt;();
        <font color=blue>private</font> <font color=darkmagenta><i>QUdpSocket</i></font> broadcastSocket = <font color=blue>new</font> <font color=darkmagenta><i>QUdpSocket</i></font>();
        <font color=blue>private</font> <font color=darkmagenta><i>QTimer</i></font> broadcastTimer = <font color=blue>new</font> <font color=darkmagenta><i>QTimer</i></font>();
        <font color=blue>private</font> String username = <font color=darkgreen><i>""</i></font>;

        Signal2&lt;<font color=darkmagenta><i>QHostAddress</i></font>, Integer&gt; newConnection__hostAddress_port = <font color=blue>new</font> Signal2&lt;<font color=darkmagenta><i>QHostAddress</i></font>, Integer&gt;();

        <font color=blue>public</font> PeerManager(Server server) {
            <font color=blue>this</font>.server = server;

            List&lt;String&gt; envVariables = <font color=blue>new</font> Vector&lt;String&gt;();

            envVariables.add(<font color=darkgreen><i>"USERNAME.*"</i></font>);
            envVariables.add(<font color=darkgreen><i>"USER.*"</i></font>);
            envVariables.add(<font color=darkgreen><i>"USERDOMAIN.*"</i></font>);
            envVariables.add(<font color=darkgreen><i>"HOSTNAME.*"</i></font>);
            envVariables.add(<font color=darkgreen><i>"DOMAINNAME.*"</i></font>);

            List&lt;String&gt; environment = <font color=darkmagenta><i>QProcess</i></font>.systemEnvironment();

            <font color=blue>for</font> (String string : envVariables) {
                <font color=blue>int</font> index = 0;
                <font color=blue>for</font> (String entry : environment) {
                    <font color=blue>if</font> (<font color=blue>new</font> <font color=darkmagenta><i>QRegExp</i></font>(string).exactMatch(entry))
                        <font color=blue>break</font>;
                    index++;
                }
                <font color=blue>if</font> (index &lt; environment.size()) {
                    String[] stringList = environment.get(index).split(<font color=darkgreen><i>"="</i></font>);
                    <font color=blue>if</font> (stringList.length == 2) {
                        username = stringList[1];
                        <font color=blue>break</font>;
                    }
                }
            }

            <font color=blue>if</font> (username.equals(<font color=darkgreen><i>""</i></font>))
                username = <font color=darkgreen><i>"unknown"</i></font>;

            updateAddresses();

            broadcastSocket.bind(<font color=blue>new</font> <font color=darkmagenta><i>QHostAddress</i></font>(<font color=darkmagenta><i>QHostAddress</i></font>.SpecialAddress.Any), broadcastPort, <font color=blue>new</font> <font color=darkmagenta><i>QUdpSocket</i></font>.BindMode(<font color=darkmagenta><i>QUdpSocket</i></font>.BindFlag.ShareAddress,
                    <font color=darkmagenta><i>QUdpSocket</i></font>.BindFlag.ReuseAddressHint));

            broadcastSocket.readyRead.connect(<font color=blue>this</font>, <font color=darkgreen><i>"readBroadcastDatagram()"</i></font>);

            broadcastTimer.setInterval(BroadcastInterval);

            broadcastTimer.timeout.connect(<font color=blue>this</font>, <font color=darkgreen><i>"sendBroadcastDatagram()"</i></font>);

        }

        String userName() {
            <font color=blue>return</font> username;
        }

        <font color=blue>void</font> startBroadcasting() {
            broadcastTimer.start();
        }

        <font color=blue>private</font> <font color=blue>boolean</font> isLocalHostAddress(<font color=blue>final</font> <font color=darkmagenta><i>QHostAddress</i></font> address) {
            <font color=blue>for</font> (<font color=darkmagenta><i>QHostAddress</i></font> localAddress : ipAddresses) {
                <font color=blue>if</font> (address.equals(localAddress)) {
                    <font color=blue>return</font> true;
                }
            }
            <font color=blue>return</font> false;
        }

        <font color=blue>void</font> sendBroadcastDatagram() {
            <font color=darkmagenta><i>QByteArray</i></font> datagram = <font color=blue>new</font> <font color=darkmagenta><i>QByteArray</i></font>(username + <font color=darkgreen><i>"@"</i></font> + server.serverPort());
            <font color=blue>boolean</font> validBroadcastAddresses = true;
            <font color=blue>for</font> (<font color=darkmagenta><i>QHostAddress</i></font> address : broadcastAddresses) {
                <font color=blue>if</font> (broadcastSocket.writeDatagram(datagram, address, broadcastPort) == -1)
                    validBroadcastAddresses = false;
            }

            <font color=blue>if</font> (!validBroadcastAddresses)
                updateAddresses();
        }

        <font color=blue>void</font> readBroadcastDatagram() {
            <font color=blue>while</font> (broadcastSocket.hasPendingDatagrams()) {
                <font color=blue>byte</font> datagram[] = <font color=blue>new</font> <font color=blue>byte</font>[(<font color=blue>int</font>) broadcastSocket.pendingDatagramSize()];
                <font color=darkmagenta><i>QUdpSocket</i></font>.HostInfo info = <font color=blue>new</font> <font color=darkmagenta><i>QUdpSocket</i></font>.HostInfo();
                <font color=blue>if</font> (broadcastSocket.readDatagram(datagram, info) == -1)
                    <font color=blue>continue</font>;

                <font color=darkmagenta><i>QByteArray</i></font> baDatagram = <font color=blue>new</font> <font color=darkmagenta><i>QByteArray</i></font>(datagram);
                List&lt;<font color=darkmagenta><i>QByteArray</i></font>&gt; list = baDatagram.split((<font color=blue>byte</font>) '@');
                <font color=blue>if</font> (list.size() != 2)
                    <font color=blue>continue</font>;

                <font color=blue>int</font> senderServerPort = Integer.parseInt(list.get(1).toString());

                <font color=blue>if</font> (isLocalHostAddress(info.address) && (senderServerPort == server.serverPort())) {
                    <font color=blue>continue</font>;
                }
                newConnection__hostAddress_port.emit(info.address, senderServerPort);
            }
        }

        <font color=blue>private</font> <font color=blue>void</font> updateAddresses() {
            updateAddresses(false);
            <font color=blue>if</font> (broadcastAddresses.isEmpty())
                updateAddresses(true);
        }

        <font color=blue>private</font> <font color=blue>void</font> updateAddresses(<font color=blue>boolean</font> enableLoopBack) {
            broadcastAddresses.clear();
            ipAddresses.clear();
            <font color=blue>for</font> (<font color=darkmagenta><i>QNetworkInterface</i></font> networkInterface : <font color=darkmagenta><i>QNetworkInterface</i></font>.allInterfaces()) {
                <font color=blue>if</font> (enableLoopBack || !networkInterface.flags().isSet(<font color=darkmagenta><i>QNetworkInterface</i></font>.InterfaceFlag.IsLoopBack)) {
                    <font color=blue>for</font> (<font color=darkmagenta><i>QNetworkAddressEntry</i></font> entry : networkInterface.addressEntries()) {

                        <font color=darkmagenta><i>QHostAddress</i></font> broadcastAddress = entry.broadcast();
                        <font color=blue>if</font> (!broadcastAddress.equals(<font color=darkmagenta><i>QHostAddress</i></font>.SpecialAddress.Null)) {
                            broadcastAddresses.add(broadcastAddress);
                        }
                        ipAddresses.add(entry.ip());
                    }
                }
            }
        }
    }

    <font color=blue>class</font> Server <font color=blue>extends</font> <font color=darkmagenta><i>QTcpServer</i></font> {
        Signal1&lt;Integer&gt; newConnection__descriptor = <font color=blue>new</font> Signal1&lt;Integer&gt;();

        <font color=blue>public</font> Server(<font color=darkmagenta><i>QObject</i></font> parent) {
            <font color=blue>super</font>(parent);
            listen(<font color=blue>new</font> <font color=darkmagenta><i>QHostAddress</i></font>(<font color=darkmagenta><i>QHostAddress</i></font>.SpecialAddress.Any), 0);
        }

        <font color=blue>public</font> <font color=blue>void</font> incomingConnection(<font color=blue>int</font> socketDescriptor) {
            newConnection__descriptor.emit(socketDescriptor);
        }
    }
}
</html></pre><p /><address><hr /><div align="center">
 <table width="100%" cellspacing="0" border="0"><tr class="address">
 <td width="30%">Copyright &copy; 2009 Nokia Corporation and/or its subsidiary(-ies)</td>
 <td width="40%" align="center"><a href="trademarks.html">Trademarks</a></td>
 <td width="30%" align="right"><div align="right">Qt Jambi 4.5.2_01</div></td>
 </tr></table></div></address></body></html>
